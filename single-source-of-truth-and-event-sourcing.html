<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>工作雜談：多餘的 DB 欄位跟關聯</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="keep calm and eat eight Plates." />
    <link rel="shortcut icon" href="/blog/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="/blog/single-source-of-truth-and-event-sourcing" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Fumitsuki's magic box" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="工作雜談：多餘的 DB 欄位跟關聯" />
    <meta property="og:description" content="最近在工作上遇到很困擾的事情之一，就是在資料的架構上，前人建了很多重複、多餘的關聯跟欄位。 多餘的關聯 例如系統中有很多使用者（users），每個使用者一定會屬於一間店家（stores），但這些店家之間不會共用使用者資料，使用者上會有 store_id 欄位去紀錄這個多對一的關聯。 接者，每個使用者都有他綁定的支付方式（payment_methods），一個支付方式只屬於一位使用者，沒有共用的狀況。支付方式上會有 user_id 紀錄他屬於哪一個使用者。 如果今天我想在支付方式列表上看見這是哪個店家底下的支付方式，我應該會從支付方式找到關聯的使用者，再找到所屬的店家。但前人可能覺得「一直 JOIN 好麻煩哪」之類的，於是錢包上也多了一個 store_id 去紀錄關聯到的店家。 整個資料庫多了好幾條關聯看起來都是為了少幾條 JOIN 建的，卻搞得撈資料的人不知道多個來源到底哪一個才是對的。這個時候如果錢包的 store_id 跟所屬 user 身上的 store_id 不同的時候，就會相當懊惱我到底該相信誰。 多餘的欄位 舉例來說，訂單（orders）底下會有很多刷卡紀錄（payments）。例如訂單有可能刷卡失敗，最後終於刷成功時，整張訂單才算是付款成功了。 或者是，訂單可能會有退款紀錄，可能部分退款，也可能是全額退款。可能退款 10 元，也可能退款 20 元。訂單上有付款狀態（payment_state）、退款金額（refund_amount）這樣的欄位在紀錄付款結果、退款金額。 原本另開欄位可能是圖個方便直接拿欄位的數值來使用，但當 code 寫爛了的時候，就會發生一些狀態不一致，不知道哪個欄位才是正確的問題。例如，當付款狀態（payment_state）是的「訂單等待付款（pending）」，但訂單卻有付款成功的紀錄時，我應該相信誰？如果訂單有一筆成功退 10 元的退款紀錄，但這筆訂單的退款金額（refund_amount）卻還是 0 的時候，是不是我拿訂單的退款金額（refund_amount）去做後續的判斷跟分析時，會大錯特錯？ Single Source of Truth 關於以上的例子，第一個想要談談的概念是 Single Source of Truth。單一事實來源（Single Source of Truth，SSOT）大致上的意思是說，資料應該要由同一個來源讀取跟計算數值。 在以上讓我困擾的例子中，很大的問題是我會有兩個以上的 data" />
    <meta property="og:url" content="/blog/single-source-of-truth-and-event-sourcing" />
    <meta property="og:image" content="/blog/assets/images/mess.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2022-06-23T18:23:00+08:00" />
    <meta property="article:modified_time" content="2022-06-23T18:23:00+08:00" />
    <meta property="article:tag" content="Sql" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="工作雜談：多餘的 DB 欄位跟關聯" />
    <meta name="twitter:description" content="最近在工作上遇到很困擾的事情之一，就是在資料的架構上，前人建了很多重複、多餘的關聯跟欄位。 多餘的關聯 例如系統中有很多使用者（users），每個使用者一定會屬於一間店家（stores），但這些店家之間不會共用使用者資料，使用者上會有 store_id 欄位去紀錄這個多對一的關聯。 接者，每個使用者都有他綁定的支付方式（payment_methods），一個支付方式只屬於一位使用者，沒有共用的狀況。支付方式上會有 user_id 紀錄他屬於哪一個使用者。 如果今天我想在支付方式列表上看見這是哪個店家底下的支付方式，我應該會從支付方式找到關聯的使用者，再找到所屬的店家。但前人可能覺得「一直 JOIN 好麻煩哪」之類的，於是錢包上也多了一個 store_id 去紀錄關聯到的店家。 整個資料庫多了好幾條關聯看起來都是為了少幾條 JOIN 建的，卻搞得撈資料的人不知道多個來源到底哪一個才是對的。這個時候如果錢包的 store_id 跟所屬 user 身上的 store_id 不同的時候，就會相當懊惱我到底該相信誰。 多餘的欄位 舉例來說，訂單（orders）底下會有很多刷卡紀錄（payments）。例如訂單有可能刷卡失敗，最後終於刷成功時，整張訂單才算是付款成功了。 或者是，訂單可能會有退款紀錄，可能部分退款，也可能是全額退款。可能退款 10 元，也可能退款 20 元。訂單上有付款狀態（payment_state）、退款金額（refund_amount）這樣的欄位在紀錄付款結果、退款金額。 原本另開欄位可能是圖個方便直接拿欄位的數值來使用，但當 code 寫爛了的時候，就會發生一些狀態不一致，不知道哪個欄位才是正確的問題。例如，當付款狀態（payment_state）是的「訂單等待付款（pending）」，但訂單卻有付款成功的紀錄時，我應該相信誰？如果訂單有一筆成功退 10 元的退款紀錄，但這筆訂單的退款金額（refund_amount）卻還是 0 的時候，是不是我拿訂單的退款金額（refund_amount）去做後續的判斷跟分析時，會大錯特錯？ Single Source of Truth 關於以上的例子，第一個想要談談的概念是 Single Source of Truth。單一事實來源（Single Source of Truth，SSOT）大致上的意思是說，資料應該要由同一個來源讀取跟計算數值。 在以上讓我困擾的例子中，很大的問題是我會有兩個以上的 data" />
    <meta name="twitter:url" content="/blog/" />
    <meta name="twitter:image" content="/blog/assets/images/mess.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Fumitsuki's magic box" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Sql" />
    <meta name="twitter:site" content="@Fumitsuki0802" />
    <meta name="twitter:creator" content="@Fumitsuki0802" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Fumitsuki's magic box",
        "logo": "/blog/assets/images/blog-icon.png"
    },
    "url": "/blog/single-source-of-truth-and-event-sourcing",
    "image": {
        "@type": "ImageObject",
        "url": "/blog/assets/images/mess.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/blog/single-source-of-truth-and-event-sourcing"
    },
    "description": "最近在工作上遇到很困擾的事情之一，就是在資料的架構上，前人建了很多重複、多餘的關聯跟欄位。 多餘的關聯 例如系統中有很多使用者（users），每個使用者一定會屬於一間店家（stores），但這些店家之間不會共用使用者資料，使用者上會有 store_id 欄位去紀錄這個多對一的關聯。 接者，每個使用者都有他綁定的支付方式（payment_methods），一個支付方式只屬於一位使用者，沒有共用的狀況。支付方式上會有 user_id 紀錄他屬於哪一個使用者。 如果今天我想在支付方式列表上看見這是哪個店家底下的支付方式，我應該會從支付方式找到關聯的使用者，再找到所屬的店家。但前人可能覺得「一直 JOIN 好麻煩哪」之類的，於是錢包上也多了一個 store_id 去紀錄關聯到的店家。 整個資料庫多了好幾條關聯看起來都是為了少幾條 JOIN 建的，卻搞得撈資料的人不知道多個來源到底哪一個才是對的。這個時候如果錢包的 store_id 跟所屬 user 身上的 store_id 不同的時候，就會相當懊惱我到底該相信誰。 多餘的欄位 舉例來說，訂單（orders）底下會有很多刷卡紀錄（payments）。例如訂單有可能刷卡失敗，最後終於刷成功時，整張訂單才算是付款成功了。 或者是，訂單可能會有退款紀錄，可能部分退款，也可能是全額退款。可能退款 10 元，也可能退款 20 元。訂單上有付款狀態（payment_state）、退款金額（refund_amount）這樣的欄位在紀錄付款結果、退款金額。 原本另開欄位可能是圖個方便直接拿欄位的數值來使用，但當 code 寫爛了的時候，就會發生一些狀態不一致，不知道哪個欄位才是正確的問題。例如，當付款狀態（payment_state）是的「訂單等待付款（pending）」，但訂單卻有付款成功的紀錄時，我應該相信誰？如果訂單有一筆成功退 10 元的退款紀錄，但這筆訂單的退款金額（refund_amount）卻還是 0 的時候，是不是我拿訂單的退款金額（refund_amount）去做後續的判斷跟分析時，會大錯特錯？ Single Source of Truth 關於以上的例子，第一個想要談談的概念是 Single Source of Truth。單一事實來源（Single Source of Truth，SSOT）大致上的意思是說，資料應該要由同一個來源讀取跟計算數值。 在以上讓我困擾的例子中，很大的問題是我會有兩個以上的 data"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="工作雜談：多餘的 DB 欄位跟關聯" href="/blog/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="/blog/"><img src="/blog/assets/images/blog-icon.png" alt="Fumitsuki's magic box" /></a>
            
        
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/Fumitsuki0802" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-sql post ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="23 June 2022">23 June 2022</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/blog/tag/sql/'>SQL</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">工作雜談：多餘的 DB 欄位跟關聯</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/blog/assets/images/mess.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>最近在工作上遇到很困擾的事情之一，就是在資料的架構上，前人建了很多重複、多餘的關聯跟欄位。</p>

<h2 id="多餘的關聯">多餘的關聯</h2>

<p>例如系統中有很多使用者（<code class="language-plaintext highlighter-rouge">users</code>），每個使用者一定會屬於一間店家（<code class="language-plaintext highlighter-rouge">stores</code>），但這些店家之間不會共用使用者資料，使用者上會有 <code class="language-plaintext highlighter-rouge">store_id</code> 欄位去紀錄這個多對一的關聯。</p>

<p><img src="/blog/assets/images/20220623-order-store.png" alt="DB diagram of orders and stores" /></p>

<p>接者，每個使用者都有他綁定的支付方式（<code class="language-plaintext highlighter-rouge">payment_methods</code>），一個支付方式只屬於一位使用者，沒有共用的狀況。支付方式上會有 <code class="language-plaintext highlighter-rouge">user_id</code> 紀錄他屬於哪一個使用者。</p>

<p><img src="/blog/assets/images/20220623-store-order-payment_method.png" alt="DB diagram of orders, stores, and payment-methods" /></p>

<p>如果今天我想在支付方式列表上看見這是哪個店家底下的支付方式，我應該會從支付方式找到關聯的使用者，再找到所屬的店家。但前人可能覺得「一直 JOIN 好麻煩哪」之類的，於是錢包上也多了一個 <code class="language-plaintext highlighter-rouge">store_id</code> 去紀錄關聯到的店家。</p>

<p><img src="/blog/assets/images/20220623-storeid-redundant.png" alt="DB diagram with redundant store_id" /></p>

<p>整個資料庫多了好幾條關聯看起來都是為了少幾條 JOIN 建的，卻搞得撈資料的人不知道多個來源到底哪一個才是對的。這個時候如果錢包的 <code class="language-plaintext highlighter-rouge">store_id</code> 跟所屬 <code class="language-plaintext highlighter-rouge">user</code> 身上的 <code class="language-plaintext highlighter-rouge">store_id</code> 不同的時候，就會相當懊惱我到底該相信誰。</p>

<p><img src="/blog/assets/images/20220623-user-payment-method-problem.png" alt="store_ids are not same" /></p>

<h2 id="多餘的欄位">多餘的欄位</h2>

<p>舉例來說，訂單（orders）底下會有很多刷卡紀錄（payments）。例如訂單有可能刷卡失敗，最後終於刷成功時，整張訂單才算是付款成功了。</p>

<p><img src="/blog/assets/images/20220623-order-payment.png" alt="DB diagram with orders and payments" /></p>

<p>或者是，訂單可能會有退款紀錄，可能部分退款，也可能是全額退款。可能退款 10 元，也可能退款 20 元。訂單上有付款狀態（<code class="language-plaintext highlighter-rouge">payment_state</code>）、退款金額（<code class="language-plaintext highlighter-rouge">refund_amount</code>）這樣的欄位在紀錄付款結果、退款金額。</p>

<p><img src="/blog/assets/images/20220623-order-payment-problem.png" alt="payment_state and refund_amount are not same" /></p>

<p>原本另開欄位可能是圖個方便直接拿欄位的數值來使用，但當 code 寫爛了的時候，就會發生一些狀態不一致，不知道哪個欄位才是正確的問題。例如，當付款狀態（<code class="language-plaintext highlighter-rouge">payment_state</code>）是的「訂單等待付款（<code class="language-plaintext highlighter-rouge">pending</code>）」，但訂單卻有付款成功的紀錄時，我應該相信誰？如果訂單有一筆成功退 10 元的退款紀錄，但這筆訂單的退款金額（<code class="language-plaintext highlighter-rouge">refund_amount</code>）卻還是 0 的時候，是不是我拿訂單的退款金額（<code class="language-plaintext highlighter-rouge">refund_amount</code>）去做後續的判斷跟分析時，會大錯特錯？</p>

<p><img src="/blog/assets/images/20220623-order-payment2.png" alt="DB diagram with orders and payments, and there are payment_state and refund_amount on orders" /></p>

<h2 id="single-source-of-truth">Single Source of Truth</h2>

<p>關於以上的例子，第一個想要談談的概念是 Single Source of Truth。單一事實來源（Single Source of Truth，SSOT）大致上的意思是說，資料應該要由同一個來源讀取跟計算數值。</p>

<p>在以上讓我困擾的例子中，很大的問題是我會有兩個以上的 data source，讓我不知道應該要依循哪一個。如果今天寫 SQL 時是用 A 來源，同事卻是用 B 來源，有可能資料不一致時會帶來錯誤跟困擾。</p>

<h2 id="event-sourcing">Event Sourcing</h2>

<p>再來看看付款紀錄的例子，其實，付款狀態可以用這張訂單的「付款紀錄」的狀態去獲得，例如：</p>
<ul>
  <li>有付款成功的付款紀錄 =&gt; 訂單付款成功</li>
  <li>沒有任何付款紀錄 =&gt; 訂單等待付款</li>
  <li>有付款紀錄但沒有付款成功的 payment =&gt; 訂單付款過但失敗了</li>
</ul>

<p>退款金額在可以直接用訂單底下的退款紀錄去得到目前退過多少錢，把退款成功的退款紀錄的金額加總，就會是目前退款的金額。</p>

<p>我覺得會是用類似 event sourcing 的方式來得到訂單的付款狀態跟資訊，每個付款紀錄、退款紀錄其實相當於一個個 event，將這些 event aggregate 起來，我就可以拿到當前訂單的狀態。</p>

<p><img src="/blog/assets/images/20220623-event-sourcing.png" alt="event sourcing" /></p>

<h2 id="performance">performance</h2>

<p>我覺得前人的架構之所以會設計成這樣，可能是有 SQL 效能上的迷思。例如，如果把一些需要 JOIN 兩次以上的關聯變成 JOIN 一次就好，是不是就可以讓 SQL 效能變好了？或者是原本需要關聯到 payments 去看付款狀態跟退款金額的方式需要 JOIN payments 這張表，如果把我要的資訊放在 orders 的欄位上是不是可以少一個 JOIN 造成的負擔？</p>

<p>但我自己覺得這會是很大的效能迷思。首先，如果 JOIN 了資料，下了 WHERE，結果資料撈很久，應該先 EXPLAIN 一下，看看 SQL 到底慢在哪裡。常常很大一部分都是沒有 index，沒吃到 index 造成的問題。沒有吃到 index 的時候，資料庫可能會用逐行掃描的方式 seq scan 過整張表去找資料，</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-&gt; Seq Scan on orders (cost=0.00..504250.77 rows=11831677 width=267)
</code></pre></div></div>

<p>加好了 index 以後，如果撈取資料時有正常吃到 index，會使用 index scan 的方式去撈資料。在資料量大的時候，效能的差異會有很明顯的差別。我會覺得如果覺得 JOIN 表時， SQL 就變得好慢，應該先檢查一下 foreign key 跟 WHERE 使用的欄位有沒有好好的下到 index。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-&gt; Index Scan using index_payments_on_order_id on payments (cost=0.43..5.80 rows=1 width=1376)
Index Cond: (order_id = orders.id)
</code></pre></div></div>

<p>在 DB 的架構設計上，我覺得真的是特別需要深思熟慮的事情，後續要再盤點欄位的意義、被如何使用，甚至要想試著進行搬移整併的話都會相當困難QQ</p>


                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/blog/assets/images/fumitsuki.jpg" alt="fumitsuki" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/blog/author/fumitsuki">文月</a></h4>
                                
                                    <p>擅長耍雷的フレンズ，在茫茫海海探索人生中</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/blog/author/fumitsuki">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/blog/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Fumitsuki's magic box &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/blog/tag/sql/">Sql</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/blog/sql-no-comma-seperated-list">[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/blog/sql-primary-key">[SQL] 什麼要 primary key？primary key 一定要叫 id 嗎？</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/blog/tag/sql/">
                                
                                    See all 2 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/blog/message-authentication-code">
                <div class="post-card-image" style="background-image: url(/blog/assets/images/black-background-key.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/blog/message-authentication-code">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Authentication</span>
                            
                        
                    

                    <h2 class="post-card-title">好淺好淺的談談訊息驗證碼 MAC</h2>
                </header>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/blog/assets/images/fumitsuki.jpg" alt="文月" />
                        
                        <span class="post-card-author">
                            <a href="/blog/author/fumitsuki/">文月</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/blog/ruby-permutations">
                <div class="post-card-image" style="background-image: url(/blog/assets/images/permutations.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/blog/ruby-permutations">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Ruby</span>
                            
                        
                    

                    <h2 class="post-card-title">ruby 的 permutation</h2>
                </header>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/blog/assets/images/fumitsuki.jpg" alt="文月" />
                        
                        <span class="post-card-author">
                            <a href="/blog/author/fumitsuki/">文月</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="/blog/">
            
                <img src="/blog/assets/images/favicon.png" alt="Fumitsuki's magic box icon" />
            
            <span>Fumitsuki's magic box</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">工作雜談：多餘的 DB 欄位跟關聯</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=%E5%B7%A5%E4%BD%9C%E9%9B%9C%E8%AB%87%EF%BC%9A%E5%A4%9A%E9%A4%98%E7%9A%84+DB+%E6%AC%84%E4%BD%8D%E8%B7%9F%E9%97%9C%E8%81%AF&amp;url=https://requiemformemories.github.io/blog/single-source-of-truth-and-event-sourcing"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://requiemformemories.github.io/blog/single-source-of-truth-and-event-sourcing"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/blog/">Fumitsuki's magic box</a> &copy; 2023</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/blog/">Latest Posts</a>
                    
                    <a href="https://twitter.com/Fumitsuki0802" target="_blank" rel="noopener">Twitter</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/blog/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/blog/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69281367-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
