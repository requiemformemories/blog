<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="keep calm and eat eight Plates." />
    <link rel="shortcut icon" href="/blog/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="/blog/sql-no-comma-seperated-list" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Fumitsuki's magic box" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？" />
    <meta property="og:description" content="想當初小的在學校學 SQL 的時候，從來沒有仔細想過為什麼的多對多關聯都要再多用一個 table 來處理。 如果直接把資料想辦法塞在一個欄位裡，比方說在 table users 上新增 orders 欄位（type 為 VARCHAR），把 order_id 們像是 1, 34, 135 這樣地塞在 orders欄位中，不是也可以嗎？（或是反過來新增 users 欄位在資料表 orders 上） id name …. orders 1 Grace …. 2, 14, 65, 11 1 Carol …. 3, 2, 1, 12, 100 乍聽之下，這個想法真是聰明，這樣就可以省得新增一個表格呢！ 但是今天就要為大家破除這個迷思，一但試了一次這個方法，未來恐怕後患無窮。 未來恐怕後患無窮。 未來恐怕後患無窮。 因為很重要所以說三次（咦） 大家務必三思以後再考慮這樣設計 schema" />
    <meta property="og:url" content="/blog/sql-no-comma-seperated-list" />
    <meta property="og:image" content="/blog/assets/images/sql.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2020-04-29T14:13:00+08:00" />
    <meta property="article:modified_time" content="2020-04-29T14:13:00+08:00" />
    <meta property="article:tag" content="sql" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？" />
    <meta name="twitter:description" content="想當初小的在學校學 SQL 的時候，從來沒有仔細想過為什麼的多對多關聯都要再多用一個 table 來處理。 如果直接把資料想辦法塞在一個欄位裡，比方說在 table users 上新增 orders 欄位（type 為 VARCHAR），把 order_id 們像是 1, 34, 135 這樣地塞在 orders欄位中，不是也可以嗎？（或是反過來新增 users 欄位在資料表 orders 上） id name …. orders 1 Grace …. 2, 14, 65, 11 1 Carol …. 3, 2, 1, 12, 100 乍聽之下，這個想法真是聰明，這樣就可以省得新增一個表格呢！ 但是今天就要為大家破除這個迷思，一但試了一次這個方法，未來恐怕後患無窮。 未來恐怕後患無窮。 未來恐怕後患無窮。 因為很重要所以說三次（咦） 大家務必三思以後再考慮這樣設計 schema" />
    <meta name="twitter:url" content="/blog/" />
    <meta name="twitter:image" content="/blog/assets/images/sql.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Fumitsuki's magic box" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="sql" />
    <meta name="twitter:site" content="@Fumitsuki0802" />
    <meta name="twitter:creator" content="@Fumitsuki0802" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Fumitsuki's magic box",
        "logo": "/blog/assets/images/blog-icon.png"
    },
    "url": "/blog/sql-no-comma-seperated-list",
    "image": {
        "@type": "ImageObject",
        "url": "/blog/assets/images/sql.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/blog/sql-no-comma-seperated-list"
    },
    "description": "想當初小的在學校學 SQL 的時候，從來沒有仔細想過為什麼的多對多關聯都要再多用一個 table 來處理。 如果直接把資料想辦法塞在一個欄位裡，比方說在 table users 上新增 orders 欄位（type 為 VARCHAR），把 order_id 們像是 1, 34, 135 這樣地塞在 orders欄位中，不是也可以嗎？（或是反過來新增 users 欄位在資料表 orders 上） id name …. orders 1 Grace …. 2, 14, 65, 11 1 Carol …. 3, 2, 1, 12, 100 乍聽之下，這個想法真是聰明，這樣就可以省得新增一個表格呢！ 但是今天就要為大家破除這個迷思，一但試了一次這個方法，未來恐怕後患無窮。 未來恐怕後患無窮。 未來恐怕後患無窮。 因為很重要所以說三次（咦） 大家務必三思以後再考慮這樣設計 schema"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？" href="/blog/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="/blog/"><img src="/blog/assets/images/blog-icon.png" alt="Fumitsuki's magic box" /></a>
            
        
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-fb" href="https://github.com/requiemformemories" target="_blank" rel="noopener"><?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 18.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 478.613 478.613" xml:space="default" width="19px" height="32px">
<g id="XMLID_122_">
	<g>
		<path d="M427.501,200.695c1.776-11.238,2.884-23.56,3.163-37.377c-0.107-59.246-28.468-80.21-33.925-90.038    c8.037-44.89-1.331-65.309-5.688-72.299c-16.07-5.704-55.91,14.722-77.678,29.101c-35.491-10.389-110.494-9.375-138.621,2.689    C122.856-4.389,95.408,1.277,95.408,1.277s-17.745,31.82-4.691,78.371c-17.075,21.759-29.802,37.143-29.802,77.949    c0,9.773,0.607,19.008,1.637,27.893c14.705,77.318,75.97,110.674,136.15,116.426c-9.056,6.881-19.928,19.903-21.432,34.992    c-11.379,7.357-34.268,9.789-52.067,4.193c-24.939-7.88-34.486-57.266-71.833-50.221c-8.081,1.512-6.475,6.842,0.523,11.386    c11.378,7.38,22.094,16.554,30.354,36.185c6.344,15.072,19.687,41.982,61.873,41.982c16.747,0,28.477-1.979,28.477-1.979    s0.319,38.406,0.319,53.385c0,17.238-23.264,22.078-23.264,30.348c0,3.289,7.7,3.601,13.888,3.601    c12.229,0,37.673-10.186,37.673-28.103c0-14.237,0.227-62.081,0.227-70.46c0-18.307,9.811-24.136,9.811-24.136    s1.201,97.727-2.361,110.829c-4.177,15.408-11.744,13.219-11.744,20.076c0,10.233,30.589,2.502,40.735-19.897    c7.849-17.495,4.334-113.331,4.334-113.331l8.183-0.178c0,0,0.094,43.892-0.188,63.944c-0.295,20.769-2.438,47.025,9.898,59.417    c8.097,8.15,32.903,22.451,32.903,9.382c0-7.574-17.371-13.833-17.371-34.353V344.45c10.553,0,12.734,31.072,12.734,31.072    l3.804,57.727c0,0-2.526,21.065,22.756,29.856c8.925,3.126,28.018,3.976,28.913-1.271c0.897-5.26-22.99-13.038-23.217-29.342    c-0.123-9.93,0.445-15.742,0.445-58.934c0-43.168-5.799-59.137-26.007-71.863C355.669,295.681,416.536,269.51,427.501,200.695z" fill="white"/>
	</g>
</g>
</svg>
</a>
            
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/Fumitsuki0802" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-speeches ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="29 April 2020">29 April 2020</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/blog/tag/sql/'>SQL</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/blog/assets/images/sql.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>想當初小的在學校學 SQL 的時候，從來沒有仔細想過為什麼的多對多關聯都要再多用一個 table 來處理。</p>

<p>如果直接把資料想辦法塞在一個欄位裡，比方說在 table <code class="highlighter-rouge">users</code> 上新增 <code class="highlighter-rouge">orders</code> 欄位（type 為 <code class="highlighter-rouge">VARCHAR</code>），把 order_id 們像是 <code class="highlighter-rouge">1, 34, 135</code> 這樣地塞在 <code class="highlighter-rouge">orders</code>欄位中，不是也可以嗎？（或是反過來新增 <code class="highlighter-rouge">users</code> 欄位在資料表 <code class="highlighter-rouge">orders</code> 上）</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>name</th>
      <th>….</th>
      <th>orders</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Grace</td>
      <td>….</td>
      <td>2, 14, 65, 11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Carol</td>
      <td>….</td>
      <td>3, 2, 1, 12, 100</td>
    </tr>
  </tbody>
</table>

<p>乍聽之下，這個想法真是聰明，這樣就可以省得新增一個表格呢！</p>

<p>但是今天就要為大家破除這個迷思，一但試了一次這個方法，<strong>未來恐怕後患無窮</strong>。</p>

<p><strong>未來恐怕後患無窮</strong>。</p>

<p><strong>未來恐怕後患無窮</strong>。</p>

<p>因為很重要所以說三次（咦）</p>

<p>大家務必三思以後再考慮這樣設計 schema 呢。</p>

<h2 id="problem-1-當我想要在-users-裡-where-order_id--11卻發現行不通">Problem 1: 當我想要在 <code class="highlighter-rouge">users</code> 裡 <code class="highlighter-rouge">WHERE order_id = 11</code>，卻發現行不通。</h2>

<p>如果我<del>沒有採用這大膽的想法</del>乖乖地把 user 跟 order 用另一張表 <code class="highlighter-rouge">user_orders</code> 來整理他們之間的多對多關係，就可以像這樣查找 id 為 11 的 order 對應到哪些 user：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">users</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">JOIN</span> <span class="n">user_orders</span>
                          <span class="k">ON</span> <span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">user_orders</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">order_id</span> <span class="o">=</span> <span class="mi">11</span>
</code></pre></div></div>

<p>但如果今天是上面那個存 comma-seperated list 的做法呢？</p>

<p>這個時候只好改寫醜一點的 SQL query 來查找你要的 users，比方說想辦法用 REGEXP 去 match 它：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">orders</span> <span class="n">REGEXP</span> <span class="s1">'[[:&lt;:]]11[[:&gt;:]]'</span>
</code></pre></div></div>

<p>一方面要提心吊膽自己的 REGEXP 沒寫法，會 match 到不該 match 的，另一方面還要擔心資料有不符合規範的東西，例如 <code class="highlighter-rouge">1, 2, 4, 11aaaa, 12</code> 等等。自己 match 資料時出錯的風險也大大提高。</p>

<p>除此之外，查找 order_id 的部分也無法加 index 來提升效能。</p>

<h2 id="problem-2-很難反過來找使用者的訂單資料">Problem 2: 很難反過來找使用者的訂單資料</h2>

<p>接著，如果我今天想要找<code class="highlighter-rouge">id</code> 為 1 的 user 的訂單資料，如果是乖乖新增第三張表的時候，可以簡單地 join table 解決。如果是現在這個 comma-seperated list 的作法，就只好再來寫醜醜的 SQL：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">JOIN</span> <span class="n">orders</span>
                    <span class="k">ON</span> <span class="n">users</span><span class="p">.</span><span class="n">orders</span> <span class="n">REGEXP</span> <span class="s1">'[[:&lt;:]]'</span> <span class="o">||</span> <span class="n">orders</span><span class="p">.</span><span class="n">id</span> <span class="o">||</span> <span class="s1">'[[:&gt;:]]'</span>
<span class="k">WHERE</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>是否開始感覺到為了一時輕率的選擇，造成的後果要用一世來彌補（欸）</p>

<p>然而問題還沒完，讓我們望向第三個問題。</p>

<h2 id="problem-3-不能用sumavg-等等-function-來做-aggregate-queries">Problem 3: 不能用<code class="highlighter-rouge">SUM()</code>、<code class="highlighter-rouge">AVG()</code> 等等 function 來做 aggregate queries</h2>

<p>如果今天你想要統計每個使用者有多少訂單，如果是好好地使用第三張表的做法，就可以簡單地使用 <code class="highlighter-rouge">SUM()</code> 來找出訂單數量：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="n">user_orders</span><span class="p">.</span><span class="n">order_id</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">JOIN</span> <span class="n">user_orders</span>
                                            <span class="k">ON</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">user_orders</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span>
</code></pre></div></div>

<p>但是用了 comma-seperated list 以後，這些資料不是分開一個 row 一個 row，而是全部擠在某個 user 的一個欄位裡。這個時候要計算訂單數量只好用一些奇妙的方法來解決。</p>

<p>比方說，如果保證每個使用者一定有對應的帳單的話，就可以透過「逗點的數量」來計算有幾筆訂單。</p>

<ul>
  <li><code class="highlighter-rouge">12</code>: 一筆訂單</li>
  <li><code class="highlighter-rouge">12, 27</code>: 兩筆訂單</li>
  <li><code class="highlighter-rouge">12, 27, 33</code>: 三筆訂單</li>
  <li><code class="highlighter-rouge">12, 27, 33, 65</code>: 四筆訂單</li>
</ul>

<p>也就是說，逗點數量 + 1 會是訂單數量。於是就可以透過 (總字數) - (去掉 <code class="highlighter-rouge">,</code> 的字數) 來計算有幾個逗號。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">length</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">-</span> <span class="k">length</span><span class="p">(</span><span class="k">REPLACE</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="s1">','</span><span class="p">,</span><span class="s1">''</span><span class="p">))</span> <span class="o">+</span><span class="mi">1</span> <span class="k">FROM</span> <span class="n">users</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="problem-4-順序問題">Problem 4: 順序問題</h2>

<p>想到這個 comma-seperated list 的做法的朋友們，可能會想說這個做法最簡單的地方在於，可以簡單地 append 新的 order_id 在欄位的最後面。比方說，id 為 5 的 user 原本的 orders 是 <code class="highlighter-rouge">11, 14, 18</code>，如果要建立他跟 id 為 20 帳單的關係，只要在 <code class="highlighter-rouge">11, 14, 18</code> 後面加上逗號與 20 就好，變成 <code class="highlighter-rouge">11, 14, 18, 20</code> 這樣。</p>

<p>但是如果今天正好要加進來的 id 是 <code class="highlighter-rouge">5</code>，就會變成 <code class="highlighter-rouge">11, 14, 18, 5</code>，經過日日夜夜的累積，你的 orders 變得順序雜亂。哪天需要照順序的 id 的時候，只好一個 row 一個 row 的資料抓出來排序QQ</p>

<p>這個時候你或許會想說：「哦哦，那我再把它塞進去資料庫之前，先把新加的 <code class="highlighter-rouge">5</code> 放到正確的位置！這樣就沒問題了吧？」</p>

<p>的確是如此，這個時候必須要跑兩個 query，一個把舊資料撈出來，下一個把你把 <code class="highlighter-rouge">5</code> 加好的資料塞回去。只是當初好好地新增一張表，現在就可以用一個 SQL 就新增新的 order_id，查詢時也可以用 ORDER BY 無痛解決排序問題。</p>

<h2 id="problem-5-刪除特定-id">Problem 5: 刪除特定 id</h2>

<p>再來下一個難題是，該如何刪掉特定的 id 呢？</p>

<p>一樣要跑兩個 query，一個把資料撈出來，自己寫程式找出 id 在哪，去掉以後再把新字串塞回去。</p>

<p>開始感覺到做出了錯誤的抉擇，會讓日後的維護很阿雜XD</p>

<h2 id="problem-6-資料驗證">Problem 6: 資料驗證</h2>

<p>用了 comma-seperated list 的做法以後，因為 order_id 的資料不是一個個 row 獨立存起來的，已經無法透過建立 constraint 來管理資料的正確性與完整性。當 SQL 不再幫你檢驗 constraint，如果程式那邊沒有檢查好，到時候連自己都不會知道欄位被亂塞了什麼東西（eg. <code class="highlighter-rouge">3, 12, 1, banana</code>）</p>

<h2 id="problem-7-seperator-被當成-string-的一部分">Problem 7: seperator 被當成 string 的一部分</h2>

<p>假設今天 order_id 有可能使用者自訂的字串，今天有個壞心眼的使用者，把 <code class="highlighter-rouge">a,b,c</code> 當成 order_id。於是這個 user 的 orders 就多了 <code class="highlighter-rouge">a,b,c</code>。當你要解析這個使用者有哪些訂單時，<code class="highlighter-rouge">a,b,c</code> 就很開心地被解析成 <code class="highlighter-rouge">a</code>,<code class="highlighter-rouge">b</code>,<code class="highlighter-rouge">c</code>，然後使用者永遠都無法正常地找回他的資料。</p>

<p>於是大家可能會開始想，我就用一個正常人不可能拿來用的字元當 seperator 吧！或者是在存入 order_id 時就限制不可以用 <code class="highlighter-rouge">,</code> 這個字元。的確是可以這樣修正，但如果是功能都開發下去、被使用了才出事，中途搶救也會很麻煩。</p>

<h2 id="problem-8長度限制">Problem 8:長度限制</h2>
<p>畢竟是用一個欄位來存 order_id 們，就要特別注意長度限制。比方說 <code class="highlighter-rouge">user_id</code> 是 <code class="highlighter-rouge">VARCHAR(255)</code>，如果裡面塞長度為 9 的字串，可以塞到 25 個才會爆炸。於是你只好想辦法說服你的客戶，一個 user 就是不能有太多 order。</p>

<p>這個時候，你心中的小惡魔可能會冒出來跟你說：</p>

<blockquote>
  <p>齁齁齁，有什麼關係，用 TEXT 我可以塞到 65535 bytes 呢 ヽ(́◕◞౪◟◕‵)ﾉ
TEXT 不夠我可以用 LONGTEXT 呀 (☝ ՞ਊ ՞）☝</p>
</blockquote>

<p>拜託….拜託不要亂來（欸</p>

<p>以上已經提出這種方法的八個疑慮了，就不要再用邪魔歪道與大量 workaround 來處理事情了吧。</p>

<h2 id="如何發現這個-antipattern">如何發現這個 Antipattern</h2>

<p>當專案小夥伴問你：</p>

<ol>
  <li>
    <p>「這個 list 最多會有幾個 entries 呢？」
代表他已經在算 VARCHAR 長度要給多少了 ヽ(́◕◞౪◟◕‵)ﾉ</p>
  </li>
  <li>
    <p>「用 SQL 要怎麼 match word boundary 呢？」
極有可能他正在思量怎麼從 list 裡挑出某個 entry (例子裡的 order_id) &gt;&lt;</p>
  </li>
  <li>
    <p>「這些 entries 裡會出現哪些符號呢？有什麼絕對不可能出現的特定符號嗎？」
代表他已經在考慮 seperator 要用哪個符號了 (☝ ՞ਊ ՞）☝</p>
  </li>
</ol>

<h2 id="使用這個-pattern-的合理情況">使用這個 pattern 的合理情況</h2>

<ol>
  <li>
    <p>比方說你有個欄位要顯示 comma-seperated list，你不會需要取這個 list 裡的單一 item，這個時候你可能會考慮反正規化一下，加了欄位放這個 comma-seperated list</p>
  </li>
  <li>
    <p>從別的 source 剛取回來的資料，正好有 comma-seperated list。在你 process 這些資料之前可能會考慮原封不動地存起來。</p>
  </li>
</ol>

<h2 id="解方intersection-table">解方：intersection table</h2>

<p>就跟以前學校老師講得一樣（欸
乖乖地新增一個 table 來存其他兩張 table 多對多的關係。</p>

<table>
  <thead>
    <tr>
      <th>user_id</th>
      <th>order_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3</td>
    </tr>
  </tbody>
</table>

<h2 id="補充regexp">補充：REGEXP</h2>
<p>參考 <a href="https://dev.mysql.com/doc/refman/5.7/en/regexp.html#operator_regexp">Regular Expressions - MYSQL</a></p>

<h3 id="character_class-character_class"><code class="highlighter-rouge">[=character_class=]</code>, <code class="highlighter-rouge">[:character_class:]</code></h3>

<p>在剛剛內文裡有用到的：</p>

<h3 id="-"><code class="highlighter-rouge">[[:&lt;:]], [[:&gt;:]]</code></h3>
<p>可以用來查找有沒有包含特定字串：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="s1">'a word a'</span> <span class="n">REGEXP</span> <span class="s1">'[[:&lt;:]]word[[:&gt;:]]'</span><span class="p">;</span>   <span class="o">-&gt;</span> <span class="mi">1</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="s1">'a xword a'</span> <span class="n">REGEXP</span> <span class="s1">'[[:&lt;:]]word[[:&gt;:]]'</span><span class="p">;</span>  <span class="o">-&gt;</span> <span class="mi">0</span>
</code></pre></div></div>

<hr />

<p>本文是參考 Bill Karwin 的 SQL Antipatterns 第二章 Jaywalking 彙整而成。原書說明了很多不太好的設計模式，什麼時候可以使用以及為何要避免使用等等。大家有空可以去翻閱看看哦。</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/blog/assets/images/fumitsuki.jpg" alt="fumitsuki" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/blog/author/fumitsuki">文月</a></h4>
                                
                                    <p>擅長耍雷的フレンズ，在茫茫海海探索人生中</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/blog/author/fumitsuki">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/blog/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Fumitsuki's magic box &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/blog/tag/sql/">Sql</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/blog/sql-primary-key">[SQL] 什麼要 primary key？primary key 一定要叫 id 嗎？</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/blog/tag/sql/">
                                
                                    See all 1 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/blog/install-node-lts-on-opsworks-stack">
                <div class="post-card-image" style="background-image: url(/blog/assets/images/stack.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/blog/install-node-lts-on-opsworks-stack">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Opsworks</span>
                            
                        
                            
                                <span class="post-card-tags">Nodejs</span>
                            
                        
                    

                    <h2 class="post-card-title">三分鐘教你如何在 OpsWorks Stack 上面用 12.x 的 nodejs</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>最近做案子才第一次碰到 Opsworks...</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/blog/assets/images/fumitsuki.jpg" alt="文月" />
                        
                        <span class="post-card-author">
                            <a href="/blog/author/fumitsuki/">文月</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/blog/sql-primary-key">
                <div class="post-card-image" style="background-image: url(/blog/assets/images/sql.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/blog/sql-primary-key">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Sql</span>
                            
                        
                    

                    <h2 class="post-card-title">[SQL] 什麼要 primary key？primary key 一定要叫 id 嗎？</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>問題一：可不可以不要 primary...</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/blog/assets/images/fumitsuki.jpg" alt="文月" />
                        
                        <span class="post-card-author">
                            <a href="/blog/author/fumitsuki/">文月</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="/blog/">
            
                <img src="/blog/assets/images/favicon.png" alt="Fumitsuki's magic box icon" />
            
            <span>Fumitsuki's magic box</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">[SQL] 為什麼要多一張表處理多對多關係？把數值都逗號分隔存起來不行嗎？</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=%5BSQL%5D+%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E5%A4%9A%E4%B8%80%E5%BC%B5%E8%A1%A8%E8%99%95%E7%90%86%E5%A4%9A%E5%B0%8D%E5%A4%9A%E9%97%9C%E4%BF%82%EF%BC%9F%E6%8A%8A%E6%95%B8%E5%80%BC%E9%83%BD%E9%80%97%E8%99%9F%E5%88%86%E9%9A%94%E5%AD%98%E8%B5%B7%E4%BE%86%E4%B8%8D%E8%A1%8C%E5%97%8E%EF%BC%9F&amp;url=https://requiemformemories.github.io/blog/sql-no-comma-seperated-list"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://requiemformemories.github.io/blog/sql-no-comma-seperated-list"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/blog/">Fumitsuki's magic box</a> &copy; 2020</section>
                <section class="poweredby">Published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/blog/">Latest Posts</a>
                    <a href="https://GitHub.com/requiemformemories" target="_blank" rel="noopener">Github</a>
                    <a href="https://twitter.com/Fumitsuki0802" target="_blank" rel="noopener">Twitter</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/blog/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/blog/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69281367-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
