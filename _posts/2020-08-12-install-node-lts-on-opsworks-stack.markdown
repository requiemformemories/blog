---
layout: post
current: post
class: post-template
subclass: 'post tag-speeches'
cover: 'assets/images/stack.jpg'
title: 'ä¸‰åˆ†é˜æ•™ä½ å¦‚ä½•åœ¨ OpsWorks Stack ä¸Šé¢ç”¨ 12.x çš„ nodejs'
date: 2020-08-11 12:09:00
categories: opsworks
tags: opsworks nodejs
author: fumitsuki
---

æœ€è¿‘åšæ¡ˆå­æ‰ç¬¬ä¸€æ¬¡ç¢°åˆ° Opsworks Stackï¼Œç„¶è€Œå‰›ç¢°åˆ°é€™å€‹å·¥å…·è¦ºå¾—éå¸¸å®³æ€•ã€‚é¦–å…ˆç•¶ä½ åœ¨æ–°å¢ stack çš„æ™‚å€™ï¼Œæœƒç™¼ç¾åªæœ‰ Chef 11 çš„ stack å’Œ Chef 12 çš„ stackã€‚

![æ–°å¢ stack](https://i.imgur.com/wVA9b2O.jpg)


Chef éƒ½å‡ºåˆ° 16 äº†ã€‚AWS æ˜¯æ²’æ‰“ç®—å‡ºæ–°çš„æ„æ€å— ğŸ˜¨

ç„¶å¾Œå†ä¾†çœ‹çœ‹ Chef 11 çš„ build-in recipes å’Œ OS packagesã€‚ nodejs çš„ç‰ˆæœ¬å±…ç„¶æ˜¯ 0.10.xï¼Œç¾åœ¨çš„ LTS ç‰ˆæœ¬ä¸æ˜¯ 12.x å—ï¼ˆæŠ–æŠ–æŠ–

é€™å€‹å·¥å…·åˆ°åº•ä½•æ™‚æœƒè¢« AWS æ·˜æ±°å•Šï¼Œè¦ºå¾—é©šæã€‚

nodejs é€™éº¼èˆŠï¼Œä¸€å®šæœƒæœ‰äºº[åæ‡‰](https://github.com/aws/opsworks-cookbooks/issues/377)å°å§ï¼Ÿæ²’éŒ¯ï¼


ä¸é AWS å®˜æ–¹çš„æ…‹åº¦æ˜¯å¸Œæœ›å¤§å®¶éƒ½å»ç”¨ community cookbooksï¼Œæ²’æ‰“ç®—å†æ›´æ–°ç¾æœ‰çš„ cookbooks äº†ã€‚ ç°¡å–®ç¬¬ä¸€å¥è©±æ‰“ç™¼äº†ä¾†é–‹ issueã€åŠ ä¸€çš„çœ¾äººï¼š

> Yes, please use the Chef community cookbook for Nodejs on Chef 12 for OpsWorks.

2020 å¹´çœ‹åˆ°é€™å¥è©±çš„æˆ‘è¦ºå¾—æ ¼å¤–å­ä¸–ï¼Œå«æˆ‘ä¸Šå“ªå»æ‰¾ community cookbooks å•¦ï¼ŒChef 11 è·Ÿ 12 å¤§å®¶éƒ½å·®ä¸å¤šæ”¾æ£„æ”¯æ´äº†QQ

å¦å¤–ï¼ŒChef 12 Stack å†ä¹Ÿæ²’æœ‰ build-in cookbooks äº†ï¼Œæœç„¶æ˜¯å®˜æ–¹ä¸æƒ³åœ¨ç¶­è­·é€™å€‹äº†å—XD

æ‰€å¹¸ç¶“éäº†é»‘æš—çš„ä¸€å€‹ç¦®æ‹œï¼Œçµ‚æ–¼æˆåŠŸæŠŠ nodejs override æˆ 12.x äº†ï¼çœŸæ˜¯è¬å¤©è¬åœ°ï¼

æ¥ä¸‹ä¾†å°±è·Ÿå¤§å®¶èªªèªªè©²æ€éº¼åšã€‚

## è§€å¯Ÿä¸€ä¸‹å®˜æ–¹çš„ cookbook åšäº†ä»€éº¼

ç•¶æˆ‘æŠŠ nodejs åŠ åˆ° OS package è£¡ä»¥å¾Œï¼Œè·‘ä¸€ä¸‹ setupï¼Œå†çœ‹ä¸€ä¸‹ instance log ï¼Œç™¼ç¾åŠ ä¸Šäº† nodejs å¥—ä»¶ä»¥å¾Œï¼Œå¤šäº† opsworks_nodejs é€™å€‹ cookbookã€‚

```
INFO: Storing updated cookbooks/opsworks_nodejs/recipes/create_env_file.rb in the cache.
```

è¦çœ‹çœ‹é€™å€‹ cookbook çš„å…§å®¹å¯ä»¥ä¸ç”¨ç›´æ¥ä¸Š `/opt/aws/opsworks/current/cookbooks/`ï¼Œå¯ä»¥åœ¨ [GitHub](https://github.com/aws/opsworks-cookbooks/tree/release-chef-11.10/opsworks_nodejs) ä¸ŠæŠŠä»–ä¸‹è¼‰ä¸‹ä¾†ã€‚

æ‰“é–‹ recipe çœ‹çœ‹ä»–æ˜¯æ€éº¼è£ node çš„ã€‚æœƒçœ‹åˆ°é€™å€‹ `opsworks_commons_assets_installer`

```ruby
# opsworks_nodejs/recipes/default.rb:32-39
opsworks_commons_assets_installer "Install user space OpsWorks NodeJS package" do
  asset PACKAGE_BASENAME
  version node[:opsworks_nodejs][:version]
  release node[:opsworks_nodejs][:pkgrelease]

  notifies :write, "log[downloading]", :immediately
  action :install
end
```

ä¹Ÿå°±æ˜¯ä»–æ˜¯åœ¨é€™è£¡åƒåˆ° `node[:opsworks_nodejs][:version]` ï¼Œç„¶å¾Œæœƒè©¦è‘—æŠŠé€™å€‹ç‰ˆæœ¬è£èµ·ä¾†ã€‚

é‚£é€™å€‹ installer å¹«æˆ‘å€‘åšäº†å“ªäº›äº‹å‘¢ï¼Ÿæˆ‘å€‘å¯ä»¥åœ¨ `opsworks_commons/providers/assets_installer.rb` çœ‹åˆ°ä»–çš„å¯¦ä½œã€‚è§€å¯Ÿä¸€ä¸‹å¯ä»¥çœ‹å‡ºä¾†ä»–æœƒå»ä¸€å€‹ S3 bucketï¼ˆé è¨­æ˜¯ `https://opsworks-instance-assets-us-east-1.s3.amazonaws.com`ï¼‰æŠŠå°æ‡‰çš„å¥—ä»¶åŒ…æŠ“ä¸‹ä¾†è£èµ·ä¾†ã€‚æ ¹æ“š linux ç™¼è¡Œç‰ˆã€ç™¼è¡Œç‰ˆç‰ˆæœ¬ã€è™•ç†å™¨çš„ä¸åŒæ±ºå®šåœ¨å“ªä¸€å€‹ pathã€‚

```ruby
@asset_url ||= URI.parse("#{node[:opsworks_commons][:assets_url]}/packages/#{_platform}/#{_platform_version}/#{asset_name}")
```

ä¾‹å¦‚ Amazon Linux 2018.03 æœ€å¾Œçš„ asset_url å¯èƒ½æœƒé•·é€™æ¨£ `/packages/amazon/2018.03/opsworks-nodejs-12.18.3-1.x86_64.rpm`ã€‚Ubuntu 14.04 å¯èƒ½æœƒåƒé€™æ¨£ `/packages/ubuntu/14.04/opsworks-nodejs_12.18.3-1_amd64.deb`ã€‚

AWS æä¾›çš„ bucket ä¸Šæ²’æœ‰æˆ‘å€‘è¦çš„ 12.x ç‰ˆæœ¬ï¼Œä½†æ˜¯æˆ‘å€‘å¯ä»¥è‡ªå·±æŒ‡å®šæˆ‘å€‘è¦çš„ node ç‰ˆæœ¬ï¼Œæ”¾åˆ°æˆ‘å€‘è‡ªå·±çš„ S3 ä¸Šã€‚é€™æ¨£ä¹Ÿä¸éœ€è¦é­”æ”¹å¤ªå¤šæ±è¥¿XD

ä¸éé€™é‚Šè¦ **ç‰¹åˆ¥æ³¨æ„**ï¼Œ**æ³¨æ„ï¼æ³¨æ„ï¼æ³¨æ„ï¼**ï¼Œæ—¢ç„¶æˆ‘å€‘æŠŠ asset_url æ”¹æ‰äº†ï¼Œé‚£ä¹‹å¾Œ berkshelf å„ç¨®ç©æ„å…’éƒ½æœƒè©¦åœ–å¾æˆ‘å€‘æ–°é–‹çš„ S3 bucket æŠ“ï¼Œæ‰€æœ‰æœƒç”¨åˆ°çš„å¥—ä»¶ç­‰ç­‰éƒ½è¦è¨˜å¾—æ”¾ä¸Šä¾†ã€‚

æ¯”æ–¹èªªæˆ‘ç”¨ Rails çš„ cookbookï¼Œå°±ä¸èƒ½å°‘äº† rubyã€‚å¦‚æœé–‹æ©Ÿå™¨å¤±æ•—äº†ï¼Œå¯ä»¥æª¢æŸ¥ä¸€ä¸‹ logï¼Œæ‡‰è©²æœƒå‘Šè¨´ä½ æ˜¯å°‘äº†å“ªä¸€å€‹ package æ‰æœƒ setup å¤±æ•—ã€‚åœ¨ S3 è£œä¸Šå°æ‡‰çš„ package å³å¯ã€‚

```
Failed to download asset opsworks-ruby2.5 for Install user space OpsWorks ruby package with url https://your-bucket-name.s3-your-region.amazonaws.com/packages/amazon/2018.03/opsworks-ruby25-2.5.1-1.x86_64.rpm.
```

## Override Attributes + ä¸Šå‚³ package file = å®Œæˆï¼

æ‰€ä»¥æˆ‘å€‘è¦åšçš„äº‹æƒ…æ˜¯ï¼Œæƒ³è¾¦æ³•è“‹æ‰åŸæœ¬çš„ `opsworks_nodejs` çš„ `version`ï¼Œç„¶å¾ŒæŠŠå°æ‡‰çš„ package å‚³ä¸Š S3ã€‚

è‡³æ–¼æ€éº¼è¦†è“‹æ‰ versionï¼Œå¯ä»¥çœ‹çœ‹ `opsworks_commons/attributes/customize.rb` ä¸Šé¢çš„èªªæ˜

```ruby
###
# This is the place to override the opsworks_commons cookbook's default attributes.
#
# Do not edit THIS file directly. Instead, create
# "opsworks_commons/attributes/customize.rb" in your cookbook repository and
# put the overrides in YOUR customize.rb file.
###
```

ä»–å¸Œæœ›ä½ å¦å¤–é–‹å€‹ custom-cookbookï¼Œåœ¨è£¡é¢ç•™ä¸‹é€™å€‹ customize.rb ä¾†è“‹æ‰ version çš„å€¼ã€‚æ‰€ä»¥æˆ‘å€‘å¯ä»¥å…ˆåˆ° GitHub ï¼ˆæˆ–å…¶ä»–ä½ å–œæ­¡çš„å¹³å°wï¼‰é–‹å€‹ repo ä¾†æ”¾ä½ çš„ custom-cookbookï¼Œç„¶å¾Œåœ¨è£¡é¢è¤‡è£½è²¼ä¸Š `opsworks_commons/attributes/customize.rb`ï¼ˆé‚£å€‹è¨»è§£è¦ä¸è¦ç•™è‘—çœ‹ä½ ï¼‰ã€‚

åœ¨è£¡é¢åŠ ä¸Šä½ è¦çš„ node ç‰ˆæœ¬ï¼š

```ruby
normal[:opsworks_nodejs][:version] = '12.18.3'
```

è¨˜å¾—è¦å»æ”¹ Stack settingï¼Œåˆ°`Use custom Chef cookbooks` çš„å€å¡ŠæŠŠé€™å€‹ custom-cookbook çš„ repo URLã€branch name åŠ é€²å»ã€‚

å®Œæˆç¬¬ä¸€éƒ¨åˆ†äº†ï¼Œæ¥è‘—ä¾†åšç¬¬äºŒéƒ¨åˆ†ã€‚åˆ° S3 é–‹å€‹ bucket ï¼ˆåå­—çœ‹èµ·ä¾†å°±æ˜¯è·Ÿ OpsWorks æœ‰é—œä¸”ä¸æœƒèª¤åˆªå³å¯wï¼‰ã€‚æ ¹æ“šå°æ‡‰çš„ path ä¾†æ”¾ä½ çš„ assetsã€‚åƒä¸Šé¢æåˆ°çš„ `/packages/amazon/2018.03` é€™æ¨£ã€‚ç„¶å¾ŒæŠŠ deb/rpm file å‚³ä¸Šä¾†ï¼Œåå­—æ”¹ä¸€æ”¹ã€‚åƒæ˜¯æˆ‘é™¤äº† node é‚„æœƒç”¨åˆ° berkshelf å’Œ rubyï¼Œé€™äº›ä¹Ÿè¦æ”¾ä¸Šä¾†ã€‚

ç„¶å¾Œåœ¨ custom json åŠ ä¸Šæ–°é–‹çš„ bucketï¼š
```json
"opsworks_commons": {
  "assets_url": "https://your-bucket-name.s3-your-region.amazonaws.com"
}
```

æœ€å¾Œå»é–‹å°æ–°çš„æ©Ÿå™¨ï¼ˆæˆ–æ˜¯æŠŠèˆŠçš„åœæ‰é‡é–‹ï¼‰ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰é †åˆ©å®Œæˆ setupã€‚å¦‚æœç•¶åˆæª”åæˆ– path æœ‰è¨­å®šéŒ¯ï¼Œæ‡‰è©²éƒ½å¯ä»¥åœ¨ log ä¸­æ‰¾åˆ°éŒ¯èª¤è¨Šæ¯ã€‚

å¦‚æœé †åˆ© setup äº†ï¼Œé€£ä¸Šæ©Ÿå™¨æª¢æŸ¥ä¸€ä¸‹ node ç‰ˆæœ¬æ˜¯ä¸æ˜¯å°çš„ã€‚

åŒ…å«æ©Ÿå™¨é–‹é–‹é—œé—œçš„éç¨‹å¯èƒ½ä¸æ­¢ä¸‰åˆ†é˜XD é€™æ¨£æ˜¯ä¸æ˜¯æœ‰é»æ¨™é¡Œè©æ¬º ğŸ¤­

## åŒå ´åŠ æ˜ ï¼šæ¶ˆå¤±çš„ Ruby 2.4 èˆ‡ 2.5
å¦‚æœä½ æœ‰è¨­å®šé Rails App Serverï¼Œæœƒç™¼ç¾åªæœ‰ Ruby 2.1ã€2.2ã€2.3ã€2.6ã€‚

å’¦ï¼Ÿ2.4 è·Ÿ 2.5 é£›å»å“ªäº†ï¼Ÿå¦‚æœæˆ‘æƒ³ç”¨ 2.5 è¦æ€éº¼è¾¦ï¼Ÿ

é€™ä»¶äº‹æƒ…ä¹Ÿæ˜¯æœ‰äºº[æŠ±æ€¨](https://github.com/aws/opsworks-cookbooks/issues/421)éï¼Œå®˜æ–¹ç›®å‰ç½®ä¹‹ä¸ç†ï¼ˆï¼Ÿï¼‰

ä¸éæœ‰å–„è‰¯çš„ user ä¸Šä¾†å‘Šè¨´å¤§å®¶è§£æ–¹ï¼Œå…¶å¯¦[è§£æ³•](https://github.com/aws/opsworks-cookbooks/issues/421#issuecomment-423540014)è·Ÿä¸Šè¿° nodejs çš„å·®ä¸å¤šï¼Œä¸€æ¨£æ˜¯æ”¹æ‰ ruby ç‰ˆæœ¬ã€asset urlï¼Œç„¶å¾Œè‡ªå·±æŠŠå„ç¨®å¥—ä»¶åŒ…å‚³ä¸Š S3 é€™æ¨£ã€‚


## çµè«–

å¯¦éš›ä¸Šæ“ä½œä½¿ç”¨ä»¥å¾Œï¼Œè¦ºå¾— OpsWorks Stack çš„ç¢ºæ˜¯å° DevOps äººåŠ›ä¸è¶³çš„åœ˜éšŠä¾†èªªç›¸ç•¶å‹å–„ï¼Œå¾ˆå¤šæœå‹™éƒ½è¢«æŠ½è±¡æˆå„ç¨® layerï¼Œå¾ˆå¥½åšè¨­å®šã€‚å°¤å…¶æ™‚ä½¿ç”¨ build-in cookbookï¼ŒçœŸçš„æ˜¯æ»‘é¼ é»ä¸€é»ä¸€å€‹å¥½å¥½çš„ç’°å¢ƒå°±å‡ºä¾†äº†ã€‚çœŸçš„æ˜¯å¯ä»¥ç†è§£ç‚ºä»€éº¼æ¥­ä¸»åˆ°ç¾åœ¨éƒ½é‚„æ˜¯ä½¿ç”¨... (ry

å¦‚æœä»Šå¹´é‚„æ˜¯ 2018 å¹´ä¹‹é¡çš„ï¼Œæˆ‘å¯èƒ½é‚„æ˜¯æœƒè¦ºå¾— OpsWorks Stacks çœŸæ˜¯æ£’ owo

ä¸éå“ªå¤©æ²’æœ‰å¤ªå¤š issue çºèº«ï¼Œæˆ‘é‚„æ˜¯æƒ³çœ‹çœ‹æ˜¯å¦èƒ½æ”¹ç”¨å…¶ä»–å·¥å…·www

æœ€å¾Œä¹Ÿå¸Œæœ›å¤§å®¶éƒ½æœ‰æˆåŠŸæŠŠ node è¨­å®šæˆæƒ³è¦çš„ç‰ˆæœ¬ï¼Œä¸€åˆ‡é †åˆ© ğŸŒŸ
